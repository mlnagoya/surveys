# PP-DocBee: Improving Multimodal Document Understanding Through a Bag of Tricks

# 概要

![image.png](PP-DocBee%20Improving%20Multimodal%20Document%20Understand%20256ee7728c5780d88b1bce919b241b1c/image.png)

- **モチベーション**
    - 中国語文書に対応した、マルチモーダル大規模言語モデル（MLLM）を作成し、VQAタスクを解きたい。
    - 一方で、中国語文書のデータセットは不足しているため、合成データでなんとかしたい。
- **提案手法**
    - 中国語VQAに対応した、データ（Text-rich Document, Table, Chart）を既存のOCRモデル・言語モデルなどを用いて生成するプロセスの提案。
        - 中国文書（ラベルなし）から、QAデータを生成する
    - 既存の英語文書理解を対象としたデータに加えて学習。
- **結果**
    - 英語・中国語の文書理解ベンチにて、Open-sourceモデルの中では当時の最先端、Closed-sourceモデルに迫る性能を達成。


# 本論文で扱うタスク

- **タスク**
    - VQA (Visual Question Answering)
- **言語**
    - 中国語
    - 英語
- **ドキュメント**
    - Text-rich Document
    - Table
    - Chart
    

![　　　　本論文の手法によって生成されたデータセットの内訳](PP-DocBee%20Improving%20Multimodal%20Document%20Understand%20256ee7728c5780d88b1bce919b241b1c/image%201.png)


# 提案手法

![image.png](PP-DocBee%20Improving%20Multimodal%20Document%20Understand%20256ee7728c5780d88b1bce919b241b1c/image%202.png)

- 文書における3種類のデータを対象として、それぞれに特化した生成プロセスを設ける
- 基本的には、前処理＋LLMによるQA 生成
- これらの生成プロセスを経て、**PPInfinityDocData(477k)** データセットを作成する。
    - Doc, Table, Chartで構成されるデータセット。**67%が中国語**、他は英語。
- Text-rich Document
    
    ![image.png](PP-DocBee%20Improving%20Multimodal%20Document%20Understand%20256ee7728c5780d88b1bce919b241b1c/image%203.png)
    
    テキストが豊富な文書（雑誌、新聞、科学技術論文、財務報告書、など）画像を対象に、
    
    OCR + LLMによる**QA生成**を行う。扱うモデルは以下。
    
    - PaddleOCR
        - Baidu産の軽量な OCR モデル
    - ERNIE-Bot 4.0
        - Baidu産の ChatBot モデル
    
    これにより、ドキュメント画像とVQAラベルが含まれる、VQAサンプルが得られる。
    
    この際、LLMが画像内の情報以外を参照してQA生成してしまうことを防ぐために、制約を行うようなプロンプト設計を行う。
    
    - プロンプト
    ```
    あなたは文書データ視覚質問応答対話生成システムである。あなたの主なタスクは、提供された文書画像のOCRレイアウト情報に基づいて、指示とそれに対応する回答を設計することです。これにより、得られたマルチモーダルデータをモデル学習に使用した場合、モデルはマルチモーダル文書理解能力を完全に学習することができます。
    以下は、研究報告書文書画像から抽出されたOCRレイアウト情報です：
    {json string}。このjson文字列ではなく、対応する画像を見ていると仮定してください。
    （テキスト関連の文字は行単位で認識されていますので、完全に結合して理解してください）
    その後、画像内の情報を組み合わせて、専門的な研究報告書読者の視点から
    指示と回答を設計してください。
    これらのダイアログを生成する際は、以下のガイドラインを必ず遵守してください:
    これらの指示は、以下の要件を満たす必要があります:
    **1. 指示は文書画像から情報を抽出する能力に焦点を当て、
    回答は画像から直接観察できるものでなければなりません。**
    **2. 指示文と回答は画像と高い関連性を持つ必要があり、画像なしでは回答できないものでなければなりません。**
    **指示文が画像から過剰な情報を提供し、画像なしでも回答可能な場合、厳禁です。**
    3. 指示文は画像内の情報に基づいて生成され、画像の内容と組み合わせて正確な回答が得られる必要があります。
    4. 提供されたOCRレイアウト情報内のテキスト文字には、回答の正確な内容が
    含まれています。回答が正しいことを厳格に確認し、正しくない場合は指示文と回答を生成しないでください。
    5. 各レイアウト領域タイプ（印刷テキスト、表、グラフ、印刷式、印鑑）について、文書に該当する情報が含まれる場合、そのコンテンツに基づいて指示文を生成してください。該当しない場合は生成不要です。
    6. 指示の回答は、できるだけ簡潔かつ正確に記述してください。質問を繰り返し、回答に直接回答しないでください。同時に、回答は画像の元のテキストから直接取得し、要約しないでください。
    7. 指示と質問にはレイアウト構造に関する情報を含めないでください。
    8. 指示は直接質問を提示し、「お願いします」「回答してください」「文書内に」などの表現は使用しないでください。
    9. 表に関する指示を生成する場合、表に単位、パーセンテージ、正負の符号などの関連情報が含まれる場合、回答の完全性を確保してください。
    10. 指示の生成は、元の文書のレイアウトを可能な限り維持するようにしてください。
    ```
        
    ![image.png](PP-DocBee%20Improving%20Multimodal%20Document%20Understand%20256ee7728c5780d88b1bce919b241b1c/image%204.png)
        
    
- Chart
    
    ![image.png](PP-DocBee%20Improving%20Multimodal%20Document%20Understand%20256ee7728c5780d88b1bce919b241b1c/image%205.png)
    
    MMLMは一般的にチャートの分析性能が低く、高品質な中国語チャート画像は少ない。
    
    そこで、9種にチャートタイプをまとめ、各チャートタイプの画像生成とQA生成スキームを設計し、対応するタスクタイプを質問できるようにまとめる。
    
    - チャート画像生成
        - LLaVA-Chart (Li et al.(2022))データセットから手作業のスクリーニングとフィルタリングを行うことで、2159件のチャートデータを得る（画像、コード、データテーブル）。
        - LLMを使用して、チャートに対応する**コード・データテーブルのパラメータを変更する**
            - 配色、値、テキスト(to 中国語)
        - チャート画像生成のプロンプトは、**9タイプ各々に設計する**
        - チャート画像を生成するプロンプト（area chart）


        ```
        質問 = f"あなたはデータ可視化とmatplotlibに精通した高度な人工知能です。
        以下のmatplotlibの領域図のコード：{code} に基づいて、この領域図のmatplotlibコードの多様なバージョンを生成してください。以下のオプションに従ってください：

        1. チャートに適合するデータポイントを生成し、データポイントの数は可能な限り多く設定してください。ただし、コード内でデータポイントを省略しないように注意してください。コード内にコメントを追加しないでください。
        2. 視覚化を豊かにするため、一部のデータポイントに新しい対応する値を追加または変更し、コード内で使用した最終的なテーブルデータをトリプルバックティック（‘‘‘）内に印刷してください。トリプルバックティック（‘‘‘）内には、CSVやプレーンテキストを含めないでください。
        3. より明確さや視覚的な魅力を高めるため、特定のカラーコード（例：#RRGGBB）を使用して色 scheme を変更してください。色カテゴリの使用は避けてください。
        4. チャートの幅と高さを適切に変更してください。
        5. チャートのトピック、見出し、データタイプ（トピックに適合するもの）を変更し、見出しを他の要素と重ならない適切な位置に配置してください（見出しが凡例と重ならないように注意！これら2つは離して配置してください）。トピックは{topics pool}から1つ（すべてではなく）を選択できますが、グローバルトピックの使用を最小限に抑え、温度は使用しないでください。
        6. 値の列が1つの領域チャートのみを生成し、積み重ね領域チャートは作成しないでください。
        7. チャートに注釈/テキストラベルを付与してください。ランダムなデータは使用しないでください。これらのオプションからいくつかを選択し、すべてを選択しないでください。可視化を多様化するためです。異なるデータポイントは異なる値を持つ必要があります。すべてのデータポイントを含む完全なコードを提出し、詳細を省略しないでください。

        コードがレンダリングされた後、凡例がチャート内に完全に表示されることを確認してください。まずテーブルデータを中国語で出力し、テーブルデータ形式はCSVファイルに直接書き込める形式である必要があります。その後、コードを出力してください（チャートのトピック、見出し、データタイプ（トピックに適合するもの）は中国語のまま保持してください）。コードは「‘‘‘ ‘‘‘ 」形式で含めてください。
        ```
        
            
        ![image.png](PP-DocBee%20Improving%20Multimodal%20Document%20Understand%20256ee7728c5780d88b1bce919b241b1c/image%206.png)
            
    - チャートQA生成
        - チャート画像生成で得たコードとデータテーブルを与えて、LLMにQAを生成させる
        - チャート画像のQAを生成するプロンプト
            - 翻訳
                
                > 質問 = 
                f"あなたはデータ可視化に精通した高度なAIです。
                {chart type} チャートを作成してください。
                以下に、{chart type} チャート用の matplotlib コード: {code} と対応するテーブルデータ: {table data} を示します。
                **コードではなく、コードが生成した画像を見ていると仮定してください。**
                チャートの内容に基づいて、異なるタスクタイプの質問を生成してください。
                タスクの種類は{task types}です。
                回答では、チャートの画像のみが与えられ、回答は画像に基づいて作成してください。
                テーブルデータは、画像内の関連する数値の実際の値です。
                回答が正しいことを確認してください。
                質問の値とラベルは質問の実際の根拠です。
                回答が正しいことを確認してください。
                文字列内で無効なエスケープ文字を使用しないでください。
                16進数の色ではなく、近似色名を使用してください。
                チャートに単位、% その他の情報が含まれる場合、回答における単位、% その他の情報の整合性を確保してください。
                さらに、出力結果を JSON ファイルとして保存したいので、回答を {template} のように整理し、
                JSON 内の「human」と「gpt」の値がすべて中国語であることを確認してください。 "
                > 
                
            
            ![image.png](PP-DocBee%20Improving%20Multimodal%20Document%20Understand%20256ee7728c5780d88b1bce919b241b1c/image%207.png)
            
- Table
    
    ![image.png](PP-DocBee%20Improving%20Multimodal%20Document%20Understand%20256ee7728c5780d88b1bce919b241b1c/image%208.png)
    
    こちらは基本的に、Text-rich Documentから得られるので、個別に画像を生成したりはしない。
    
    QAラベルの生成のみを行う。
    
    - 画像からHTML形式で表を抽出したのち、QA生成に投げる。
    - プロンプト
        - 翻訳
            
            ```
            質問 = f"**これはHTMLコードで表示された表チャートです: {html code}。**このチャートについて、異なるタスクタイプの質問を生成してください。質問の回答がチャートから明確に得られるようにしてください。そうでない場合は、対応するタスクを選択しないようにしてください。
            
            選択可能なタスクタイプとその説明は次のとおりです:
            ファクトイド: 特定の事実を尋ねる質問で、回答は表の断片または集計値から得られます。
            フリーフォーム: 回答に固定形式はなく、通常は長く、会話形式に似ています（例: ChatGPT）。
            複数選択: 質問には複数の選択肢から1つを選択する回答が必要です。
            リスト: 回答には関連する項目の列を複数提供する必要があります（通常は表の複数行または列から）。
            Yes/No: 質問の回答は「はい」または「いいえ」のみです。
            説明: 回答は表内の特定のデータや傾向を説明する必要があります。
            比較: 回答は表内の2つ以上の値を比較する必要があります。
            因果関係: 回答は表内のデータ間の因果関係を説明する必要があります。
            計算: 回答には合計や平均などの計算が必要です。
            分類: 質問に応じて、表内のデータを分類またはカテゴリ分けします。
            時系列: 回答には、表内の時系列データ（傾向、パターンなど）の分析が必要です。
            
            **コードによって生成された画像を見ていると想像してください。コード自体ではなく、画像を見て回答してください。**回答では、与えられるのはグラフの画像のみであり、その画像に基づいて回答してください。
            値とラベルは問題の正解です。回答が正しいことを確認してください。文字列に無効なエスケープ文字を使用しないでください。また、回答をJSONファイルに保存するため、回答を{template}の形式で整理し、回答を「‘‘‘json‘‘‘」形式で含めてください。
            ```
        
        ![image.png](PP-DocBee%20Improving%20Multimodal%20Document%20Understand%20256ee7728c5780d88b1bce919b241b1c/image%209.png)
        
    

# 結果

Qwen2-VLをベースにした**PP-DocBee**を作成する

![image.png](PP-DocBee%20Improving%20Multimodal%20Document%20Understand%20256ee7728c5780d88b1bce919b241b1c/image%2010.png)

- オープンデータと、PPInfinityDocDataで構成されるデータセットを構築して、SFTする。
- この際、VisionEncoderはフリーズさせる。
- 500万サンプルをA800 x 8で 2日かけて学習したらしい。

![image.png](PP-DocBee%20Improving%20Multimodal%20Document%20Understand%20256ee7728c5780d88b1bce919b241b1c/image%2011.png)

- 英語のベンチで、Open-sourceモデルの中では当時のSoTA、Closed-sourceモデルに迫る性能を達成。

![image.png](PP-DocBee%20Improving%20Multimodal%20Document%20Understand%20256ee7728c5780d88b1bce919b241b1c/image%2012.png)

- 独自の中国語ベンチ(Internal-CN)では、SoTA。
    - text
        - 656
    - table
        - 358
    - seals
        - 15
    - charts
        - 167

# Ablation

![image.png](PP-DocBee%20Improving%20Multimodal%20Document%20Understand%20256ee7728c5780d88b1bce919b241b1c/image%2013.png)

- PPInfinityDocDataを追加する際、20%の比率になるようにするのが一番良いらしい。30%を超えると性能が低下する。

![image.png](PP-DocBee%20Improving%20Multimodal%20Document%20Understand%20256ee7728c5780d88b1bce919b241b1c/image%2014.png)

- 提案モデルの出力。
- Chartのための、理工系論文に対するケース（？）
    - 情報の参照は、表からしているようだが、、、
    - QA
        - Q. 全負荷時のバッテリーパックのSOCの初期値は？
        - A. 0.6

# 所感

- LLMをつかったデータセット作成を色々なところで見るようになってきた気がする。
- 生成されたデータセットの品質が気になった。
    - モデルは公開されていることを確認したが、データセットがみつからなかった。
        - ドキュメントが全て中国語だったため追いきれなかった。。。